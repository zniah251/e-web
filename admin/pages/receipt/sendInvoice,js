const { getOrderData, getCustomerInfo } = require('./db');
const { generateInvoice } = require('./generateInvoice');
const { sendMailWithInvoice } = require('./sendMail');

async function handleSendInvoice(orderId) {
  try {
    // Validate orderId
    if (!orderId || isNaN(orderId)) {
      console.log('âŒ ID Ä‘Æ¡n hÃ ng khÃ´ng há»£p lá»‡.');
      return false;
    }

    console.log(`ğŸ“‹ Äang xá»­ lÃ½ Ä‘Æ¡n hÃ ng #${orderId}...`);
    
    // Láº¥y thÃ´ng tin khÃ¡ch hÃ ng trÆ°á»›c
    const customerInfo = await getCustomerInfo(orderId);
    if (!customerInfo) {
      console.log('âŒ KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin khÃ¡ch hÃ ng.');
      return false;
    }

    // Kiá»ƒm tra email há»£p lá»‡
    if (!customerInfo.email || !customerInfo.email.includes('@')) {
      console.log(`âŒ Email khÃ´ng há»£p lá»‡: ${customerInfo.email}`);
      return false;
    }

    console.log(`ğŸ‘¤ KhÃ¡ch hÃ ng: ${customerInfo.uname} (${customerInfo.email})`);
    
    const orderData = await getOrderData(orderId);
    if (!orderData || orderData.length === 0) {
      console.log('âŒ KhÃ´ng tÃ¬m tháº¥y chi tiáº¿t Ä‘Æ¡n hÃ ng.');
      return false;
    }

    console.log(`ğŸ“¦ TÃ¬m tháº¥y ${orderData.length} sáº£n pháº©m trong Ä‘Æ¡n hÃ ng`);
    
    // Táº¡o PDF vá»›i async/await
    const filePath = await generateInvoice(orderData, orderId);
    console.log(`ğŸ“„ ÄÃ£ táº¡o file PDF: ${filePath}`);
    
    const emailSent = await sendMailWithInvoice(customerInfo.email, orderId, filePath);
    
    if (emailSent) {
      console.log(`âœ… HÃ³a Ä‘Æ¡n Ä‘Ã£ Ä‘Æ°á»£c gá»­i thÃ nh cÃ´ng Ä‘áº¿n ${customerInfo.email}`);
      return true;
    } else {
      console.log('âŒ KhÃ´ng thá»ƒ gá»­i email.');
      return false;
    }
  } catch (error) {
    console.error('âš ï¸ Lá»—i:', error.message);
    return false;
  }
}

// Export function Ä‘á»ƒ cÃ³ thá»ƒ sá»­ dá»¥ng tá»« bÃªn ngoÃ i
module.exports = { handleSendInvoice };





